# 5. Estrategias de Despliegue basadas en Deployment Config

A nivel de Openshift existen varias estrategias de despliegue basadas en router que podemos usar de acuerdo a las necesidades:

Blue Green Deployment:

Deployment A/B: 



A continuación se va a desplegar un GOGS que es un SCM basado en Git para realizar los próximos laboratorios.

## 5.1 Despliegue GOGS

1. Crear un nuevo proyecto basado en su identificador de usuario  
```shell script
oc new-project gogs-user# --display-name="SCM - User#"
```

2. Crear la aplicación a partir de un template mediante el siguiente comando:

```shell script
oc new-app -f https://raw.githubusercontent.com/mirkhala/gogs-openshift-docker/master/openshift/gogs-template.yaml -p HOSTNAME=gogs-user#-gogs.[YOUR SERVER] -p SKIP_TLS_VERIFY=true -n gogs-user#
```
3. Verificar los pods. Debemos tener dos pods en estado __Running__ que están asociados a la base de datos y otro a la aplicación Gogs. 

```shell script
$ oc get pods
NAME                       READY   STATUS      RESTARTS   AGE
gogs-1-2ljk4               1/1     Running     0          106s
gogs-1-deploy              0/1     Completed   0          109s
gogs-postgresql-1-deploy   0/1     Completed   0          114s
gogs-postgresql-1-vmfz8    1/1     Running     0          111s
```
Si los pods aun no están disponible debemos esperar un poco y verificar de nuevo.

4. Obtener la ruta.

```shell script
$ oc get route
NAME       HOST/PORT                                PATH   SERVICES   PORT        TERMINATION   WILDCARD
gogs       gogs-user1-gogs.apps-crc.testing                gogs       3000-tcp                  None
gogs-ssh   securegogs-user1-gogs.apps-crc.testing          gogs       10022-tcp                 None
```

Tomar la url asociada a la ruta llamada gogs y acceder mediante el navegador. En mi caso debo acceder  a la ruta http://gogs-user1-gogs.apps-crc.testing
 

5. Al acceder a la aplicación mediante el navegador dar clic en __Register__ y proceder a registrarnos en la herramienta:
Ingresar los siguientes datos:

* Username: user# 
* Email: user$@test.com
* Password: user#
* Re-type: User#

A continuación un ejemplo de los datos diligenciado para user1
![gogs-register.png](img/gogs-register.png)


6. Migrar el repositorio al gogs.

En primera instancia debemos autenticarnos a gogs con el usuario recién creado, luego damos clic en __Mirror__ en la parte superior derecha.

Diligenciar los siguientes datos:

__Clone Address__: https://github.com/wilmeraguilera/lab-openshift/
__Repository Name__: lab-openshift

*Los demás valores dejarlos por defecto*

A continuación un ejemplo del diligenciamiento con user1
![gogs-migration-repo](img/gogs-migration-repo.png)

 

## 5.2 Blue Green

Es una estrategia que busca reducir el tiempo de indisponibilidad de una aplicación al momento de realizar un despliegue. Se requiere tener dos ambientes idénticos llamados "Blue" y "Green, uno de ellos tendrá la version estable y el otro la nueva versión. Cuando todo este correcto lo único que se cambia es la ruta para que apunte al ambiente con la nueva versión.

1. Ubicarnos en el proyecto apps-user# y verificar que no exista ningpun recurso creado.

```shell script
oc project apps-user# 
```

2. Crear la aplicación Blue

Tener especial cuidado de reemplazar los valores de [URL GOGS lab-openshift] y  [ROUTE NEXUS] de acurdo a su ambiente.

```shell script
oc new-app --name=blue  openshift/java:8~[URL GOGS lab-openshift] --context-dir=backend-users --strategy=source --build-env MAVEN_MIRROR_URL=http://[ROUTE NEXUS]/repository/maven-public/ --labels app.kubernetes.io/part-of=lab-openshift
```

3. Crear la aplicación Green

```shell script
oc new-app --name=green  openshift/java:8~[URL GOGS lab-openshift] --context-dir=backend-users --strategy=source --build-env MAVEN_MIRROR_URL=http://[ROUTE NEXUS]/repository/maven-public/ --labels app.kubernetes.io/part-of=lab-openshift
```

4. Exponer la ruta del la aplicación blue. (BlueGreen tiene una unica ruta que se estará intercambiando entre el ambiente Blue y Green)

```shell script
oc expose svc blue
```

5. Verificación creación de aplicaciones. Ir a __Topology__ y deberías ber una disposición de las aplicacione como la que se muestra a continuación.

![blue-green-apps-topology](img/blue-green-apps-topology.png)










